<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-root" content="/knowledgesystems-k8s-deployment">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.12.0.825198886595">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.12.0">

    <!-- Primary Meta Tags -->
    <title>Troubleshooting | CDSI K8s Documentation</title>
    <meta name="title" content="Troubleshooting | CDSI K8s Documentation">
    <meta name="description" content="This list is used to track issues and their remedies.">

    <!-- Canonical -->
    <link rel="canonical" href="https://knowledgesystems.github.io/knowledgesystems-k8s-deployment/troubleshooting/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://knowledgesystems.github.io/knowledgesystems-k8s-deployment/troubleshooting/">
    <meta property="og:title" content="Troubleshooting | CDSI K8s Documentation">
    <meta property="og:description" content="This list is used to track issues and their remedies.">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://knowledgesystems.github.io/knowledgesystems-k8s-deployment/troubleshooting/">
    <meta property="twitter:title" content="Troubleshooting | CDSI K8s Documentation">
    <meta property="twitter:description" content="This list is used to track issues and their remedies.">

    <script data-cfasync="false">(function(){var cl=document.documentElement.classList,ls=localStorage.getItem("retype_scheme"),hd=cl.contains("dark"),hl=cl.contains("light"),wm=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;if(ls==="dark"||(!ls&&wm&&!hd&&!hl)){cl.remove("light");cl.add("dark")}else if(ls==="light"||(!ls&&!wm&&!hd&&!hl)){cl.remove("dark");cl.add("light")}})();</script>

    <link href="../resources/css/retype.css?v=3.12.0.825198886595" rel="stylesheet">

    <script data-cfasync="false" src="../resources/js/config.js?v=3.12.0.825198886595" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../resources/js/retype.js?v=3.12.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../resources/js/lunr.js?v=3.12.0.825198886595" data-turbo-eval="false" defer></script>
    <script id="prism-js" data-cfasync="false" src="../resources/js/prism.js?v=3.12.0.825198886595" defer></script>
</head>
<body>
    <div id="retype-app" class="relative text-base antialiased text-base-text bg-base-bg font-body">
        <div class="absolute bottom-0 left-0" style="top: 5rem; right: 50%"></div>
    
        <header id="retype-header" class="sticky top-0 z-30 flex w-full h-16 bg-header-bg border-b border-header-border md:h-20">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton retype-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="retype-sidebar-left-toggle-button"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="retype-branding-logo" href="../" class="flex items-center leading-snug text-2xl">
                            <span class="dark:text-white font-bold line-clamp-1 md:line-clamp-2">CDSI K8s</span>
                        </a><span id="retype-branding-label" class="inline-flex mt-1 px-2 py-1 ml-4 text-xs font-medium leading-none items-center rounded-md bg-branding-label-bg text-branding-label-text ring-1 ring-branding-label-border ring-inset md:inline-block">Docs</span>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block border-base-border"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav id="retype-header-nav" class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text hover:text-header-text-hover" href="https://github.com/knowledgesystems/knowledgesystems-k8s-deployment" target="_blank">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                        <g fill="currentColor">
                                            <path d="M10.303 16.652c-2.837-.344-4.835-2.385-4.835-5.028 0-1.074.387-2.235 1.031-3.008-.279-.709-.236-2.214.086-2.837.86-.107 2.02.344 2.708.967.816-.258 1.676-.386 2.728-.386 1.053 0 1.913.128 2.686.365.666-.602 1.848-1.053 2.708-.946.3.581.344 2.085.064 2.815.688.817 1.053 1.913 1.053 3.03 0 2.643-1.998 4.641-4.877 5.006.73.473 1.224 1.504 1.224 2.686v2.235c0 .644.537 1.01 1.182.752 3.889-1.483 6.94-5.372 6.94-10.185 0-6.081-4.942-11.044-11.022-11.044-6.081 0-10.98 4.963-10.98 11.044a10.84 10.84 0 0 0 7.112 10.206c.58.215 1.139-.172 1.139-.752v-1.719a2.768 2.768 0 0 1-1.032.215c-1.418 0-2.256-.773-2.857-2.213-.237-.58-.495-.924-.989-.988-.258-.022-.344-.129-.344-.258 0-.258.43-.451.86-.451.623 0 1.16.386 1.719 1.181.43.623.881.903 1.418.903.537 0 .881-.194 1.375-.688.365-.365.645-.687.903-.902Z"/>
                                        </g>
                                    </svg>
                                    <span>GitHub</span>
                                </a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="retype-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
    
        <div id="retype-container" class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-sidebar-left-bg border-sidebar-left-border sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton">
            
                <div class="flex items-center h-16 px-6">
                    <input id="retype-filter-input-mock" class="w-full h-10 pl-8 px-3 py-2 transition-colors duration-200 ease-linear bg-filter-bg border border-filter-border rounded-lg shadow-none md:text-sm hover:border-filter-border-hover focus:outline-none focus:border-filter-border-focus placeholder-filter-placeholder" type="text">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                </div>
            
                <div class="shrink-0 mt-auto bg-transparent dark:border-base-border">
                    <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                        <span class="text-xs whitespace-nowrap">Powered by</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                    </a>
                </div>
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-base-border">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-base-border">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text hover:text-header-text-hover" href="https://github.com/knowledgesystems/knowledgesystems-k8s-deployment" target="_blank">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mb-px mr-1" width="18" height="18" viewBox="0 0 24 24" role="presentation">
                                                <g fill="currentColor">
                                                    <path d="M10.303 16.652c-2.837-.344-4.835-2.385-4.835-5.028 0-1.074.387-2.235 1.031-3.008-.279-.709-.236-2.214.086-2.837.86-.107 2.02.344 2.708.967.816-.258 1.676-.386 2.728-.386 1.053 0 1.913.128 2.686.365.666-.602 1.848-1.053 2.708-.946.3.581.344 2.085.064 2.815.688.817 1.053 1.913 1.053 3.03 0 2.643-1.998 4.641-4.877 5.006.73.473 1.224 1.504 1.224 2.686v2.235c0 .644.537 1.01 1.182.752 3.889-1.483 6.94-5.372 6.94-10.185 0-6.081-4.942-11.044-11.022-11.044-6.081 0-10.98 4.963-10.98 11.044a10.84 10.84 0 0 0 7.112 10.206c.58.215 1.139-.172 1.139-.752v-1.719a2.768 2.768 0 0 1-1.032.215c-1.418 0-2.256-.773-2.857-2.213-.237-.58-.495-.924-.989-.988-.258-.022-.344-.129-.344-.258 0-.258.43-.451.86-.451.623 0 1.16.386 1.719 1.181.43.623.881.903 1.418.903.537 0 .881-.194 1.375-.688.365-.365.645-.687.903-.902Z"/>
                                                </g>
                                            </svg>
                                            <span>GitHub</span>
                                        </a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
            
                        <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                            <span class="text-xs whitespace-nowrap">Powered by</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                        </a>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 bg-body-bg">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div id="retype-main" class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="retype-markdown" id="retype-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="retype-sidebar-right-toggle"></div>
                                <!-- Page content  -->
<doc-anchor-target id="troubleshooting" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#troubleshooting">#</doc-anchor-trigger>
        <span>Troubleshooting</span>
    </h1>
</doc-anchor-target>
<p>This list is used to track issues and their remedies.</p>
<doc-anchor-target id="efs-mount-failed---missing-mount-targets-in-availability-zone">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#efs-mount-failed---missing-mount-targets-in-availability-zone">#</doc-anchor-trigger>
        <span>EFS Mount Failed - Missing Mount Targets in Availability Zone</span>
    </h2>
</doc-anchor-target>
<p>When deploying applications that use EFS persistent volumes, you may encounter mount errors like:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">MountVolume.SetUp failed for volume &quot;pvc-295ec7e4-fe8f-4dc6-b5a9-70cdc6fa05ee&quot; : rpc error: code = Internal desc = Could not mount &quot;fs-017997c6e5521be56:/&quot; at &quot;/var/lib/kubelet/pods/74b06dda-6fe3-4195-9f1a-64a0ce6de954/volumes/kubernetes.io~csi/pvc-295ec7e4-fe8f-4dc6-b5a9-70cdc6fa05ee/mount&quot;: mount failed: exit status 1
...
No matching mount target in the az us-east-1a. Please create one mount target in us-east-1a, or try the mount target in another AZ by passing the availability zone name option. Available mount target(s) are in az ['us-east-1b']</code></pre>
</doc-codeblock></div>
<p>This happens when your EKS cluster nodes are running in an availability zone that doesn&#x27;t have an EFS mount target. EFS requires mount targets in each AZ where you want to access the file system.</p>
<p>To resolve this, create mount targets in the missing availability zones. You can do this via the AWS CLI:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">aws efs create-mount-target \
  --file-system-id fs-xxxxxx \
  --subnet-id subnet-xxxxxx \
  --security-groups sg-xxxxxx</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="docker-image-not-found---bitnami-legacy-images-and-helm-charts">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#docker-image-not-found---bitnami-legacy-images-and-helm-charts">#</doc-anchor-trigger>
        <span>Docker Image Not Found - Bitnami Legacy Images and Helm Charts</span>
    </h2>
</doc-anchor-target>
<p>When installing helm charts that use legacy Bitnami images, you may encounter errors like:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">Back-off pulling image &quot;docker.io/bitnami/redis:7.2.2-debian-11-r0&quot;:ErrImagePull: rpc error: code = NotFound desc = failed to pull and unpack image &quot;docker.io/bitnami/redis:7.2.2-debian-11-r0&quot;: failed to resolve reference &quot;docker.io/bitnami/redis:7.2.2-debian-11-r0&quot;: docker.io/bitnami/redis:7.2.2-debian-11-r0: not found</code></pre>
</doc-codeblock></div>
<p>This happens because some older Bitnami image versions are now located in the <code translate="no" v-pre>bitnamilegacy</code> repository instead of the main <code translate="no" v-pre>bitnami</code> repository. To solve the above issue, try providing custom image repository and registry to the helm chart. For example, for redis, you can set helm values like so:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">image:
    repository: bitnamilegacy/redis
    registry: docker.io</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="low-ephemeral-storage-issue">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#low-ephemeral-storage-issue">#</doc-anchor-trigger>
        <span>Low Ephemeral Storage Issue</span>
    </h2>
</doc-anchor-target>
<p>Our new Terraform modules use a default ephemeral storage which might not be enough for certain workloads. This leads to an error similar to the following on deployments:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">The node was low on resource: ephemeral-storage. Threshold quantity: 123456789, available: 123456Ki.</code></pre>
</doc-codeblock></div>
<p>To increase the ephemeral storage capacity for the nodegroup, update the terraform modules to use custom disk sizes. As an example, look at the current nodegroups <a href="https://github.com/knowledgesystems/knowledgesystems-k8s-deployment/blob/master/iac/aws/203403084713/clusters/cbioportal-prod/eks/main.tf#L68-L71">here</a>.</p>
<doc-anchor-target id="aws-cni-failing-to-assign-ip-addresses">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#aws-cni-failing-to-assign-ip-addresses">#</doc-anchor-trigger>
        <span>AWS-CNI Failing to Assign IP Addresses</span>
    </h2>
</doc-anchor-target>
<p>If a AWS EKS managed nodegroup has too many pods deployed on one of its EC2 nodes, it can run out of IP Addresses with the error:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">plugin type=&quot;aws-cni&quot; name=&quot;aws-cni&quot; failed (add): add cmd: failed to assign an IP address to container</code></pre>
</doc-codeblock></div>
<p>To resolve this issue, analyze the deployments in the nodegroup and see if a specific deployment group can be separated into its own nodegroup. E.g., For oncokb production workload, redis deployment needed 20 pods. In such cases, the better approach was to deploy redis in its own nodegroup called <code translate="no" v-pre>oncokb-redis</code>.</p>
<doc-anchor-target id="datadog-failing-to-inject-init-containers">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#datadog-failing-to-inject-init-containers">#</doc-anchor-trigger>
        <span>Datadog Failing to Inject Init-Containers</span>
    </h2>
</doc-anchor-target>
<p>In an AWS EKS cluster, if datadog is failing to inject init-containers because the deployments are somehow invisible to the Cluster Agent or the Cluster Agent is failing to detect them, then it could be a <a href="https://docs.datadoghq.com/containers/troubleshooting/admission-controller/?tab=helm#amazon-elastic-kubernetes-service-eks">networking issue</a>. To fix it, add the following inbound rule to the security groups attached to EC2 instances in the cluster:</p>
<ul>
<li><strong>Protocol</strong>: TCP</li>
<li><strong>Port range</strong>: <code translate="no" v-pre>8000</code>, or a range that covers <code translate="no" v-pre>8000</code></li>
<li><strong>Source</strong>: The ID of either the cluster security group, or one of your cluster’s additional security groups. You can find these IDs in the EKS console, under the Networking tab for your EKS cluster.</li>
</ul>
<p>This security group rule allows the control plane to access the node and the downstream Cluster Agent over port <code translate="no" v-pre>8000</code>.</p>
<p>If you have multiple managed node groups, each with distinct security groups, add this inbound rule to each security group.</p>
<doc-anchor-target id="mongodb-persistent-volume-claim-error">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#mongodb-persistent-volume-claim-error">#</doc-anchor-trigger>
        <span>MongoDB Persistent Volume Claim Error</span>
    </h2>
</doc-anchor-target>
<p>When installing MongoDB Helm Chart in a new cluster, we sometimes run into an error where the helm chart is unable to create a persistent volume, which leads to the persistent volume claim failing to bind:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">no persistent volumes available for this claim and no storage class is set</code></pre>
</doc-codeblock></div>
<p>This happens because in a new cluster, a default storage class for Kubernetes has not been set. Run the following commands to fix this:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash"># Get the name of the storage class
kubectl get storageclasses.storage.k8s.io

# If you get the following output, notice how there is no default tag next to the class name
# NAME  PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
# gp2   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  632d

# Patch the storage class to make it default
kubectl patch storageclass gp2 -p '{&quot;metadata&quot;: {&quot;annotations&quot;:{&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;}}}'

# Now running the following should show default storage class
kubectl get storageclasses.storage.k8s.io
# NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
# gp2 (default)   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  632d</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="nginx-ingress-helm-upgrade-errors">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#nginx-ingress-helm-upgrade-errors">#</doc-anchor-trigger>
        <span>Nginx Ingress Helm Upgrade Errors</span>
    </h2>
</doc-anchor-target>
<p>For the <code translate="no" v-pre>666628074417</code> account, upgrading Ingress controllers through Helm results in various errors due to the custom networking rules.</p>
<doc-anchor-target id="400-bad-request---the-plain-http-request-was-sent-to-https-port">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#400-bad-request---the-plain-http-request-was-sent-to-https-port">#</doc-anchor-trigger>
        <span>400 Bad Request - The plain HTTP request was sent to HTTPS port</span>
    </h3>
</doc-anchor-target>
<p>To fix this issue, apply the correct nginx controller config defined <a href="https://github.com/knowledgesystems/knowledgesystems-k8s-deployment/blob/master/digits-eks/eks-prod/shared-services/ingress/eks_ingress_controller.yaml">here</a> after updating nginx.</p>
<doc-anchor-target id="keycloak-invalid-requester-error">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#keycloak-invalid-requester-error">#</doc-anchor-trigger>
        <span>Keycloak Invalid Requester Error</span>
    </h3>
</doc-anchor-target>
<p>Keycloak fails to forward headers, which leads to the following error in the network tab when the site is accessed:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">Mixed Content: The page at 'https://keycloak.cbioportal.mskcc.org/auth/admin/master/console/' was loaded over HTTPS, but requested an insecure script 'http://keycloak.cbioportal.mskcc.org/auth/js/keycloak.js?version=4cbzu'. This request has been blocked; the content must be served over HTTPS.</code></pre>
</doc-codeblock></div>
<p>The following error is seen in the kubernetes pods for the keycloak instance:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">14:45:56,925 WARN  [org.keycloak.events] (default task-2) type=LOGIN_ERROR, realmId=msk, clientId=null, userId=null, ipAddress=10.1.141.180, error=invalid_authn_request, reason=invalid_destination
14:46:39,551 WARN  [org.keycloak.events] (default task-5) type=LOGIN_ERROR, realmId=msk, clientId=null, userId=null, ipAddress=10.1.140.190, error=invalid_authn_request, reason=invalid_destination</code></pre>
</doc-codeblock></div>
<p>To solve this issue, use the correct forwarding rules by applying the configmap defined <a href="https://github.com/knowledgesystems/knowledgesystems-k8s-deployment/blob/master/digits-eks/eks-prod/shared-services/ingress/eks_ingress_configmap.yaml">here</a> after updating nginx.</p>
<doc-anchor-target id="datadog-failed-to-auto-detect-cluster-name">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#datadog-failed-to-auto-detect-cluster-name">#</doc-anchor-trigger>
        <span>Datadog failed to auto-detect cluster name</span>
    </h2>
</doc-anchor-target>
<p>When deployed on AWS EC2 nodes using the <code translate="no" v-pre>BOTTLEROCKET_*</code> AMI types, Datadog fails to auto-detect the cluster name, resulting in the following errors:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">2025-03-10 17:39:09 UTC | CLUSTER | WARN | (subcommands/start/command.go:235 in start) | Failed to auto-detect a Kubernetes cluster name. We recommend you set it manually via the cluster_name config option
2025-03-10 17:39:10 UTC | CLUSTER | ERROR | (pkg/collector/corechecks/loader.go:64 in Load) | core.loader: could not configure check orchestrator: orchestrator check is configured but the cluster name is empty
2025-03-10 17:39:10 UTC | CLUSTER | ERROR | (pkg/collector/scheduler.go:208 in getChecks) | Unable to load a check from instance of config 'orchestrator': Core Check Loader: Could not configure check orchestrator: orchestrator check is configured but the cluster name is empty</code></pre>
</doc-codeblock></div>
<p>To solve this, either use the <code translate="no" v-pre>AL2_*</code> AMI type (NOT RECOMMENDED) or manually specify the cluster name in the Datadog helm values:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">datadog:
  clusterName: &lt;cluster-name&gt;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="datadog-always-out-of-sync-with-helm-and-argocd">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#datadog-always-out-of-sync-with-helm-and-argocd">#</doc-anchor-trigger>
        <span>Datadog always out-of-sync with helm and argocd</span>
    </h2>
</doc-anchor-target>
<p>By default, Datadog auto-assigns random values to the following on restarts:</p>
<ol>
<li>Token used for authentication between the cluster agent and node agents.</li>
<li>Configmap for the APM Instrumentation KPIs.</li>
</ol>
<p>This leads to Datadog being permanently out-of-sync when deployed with Helm and ArgoCD. To solve this issue, follow the steps below:</p>
<ol>
<li><p>Provide a cluster agent token as a secret.</p>
<ul>
<li><p>Generate a random 32-digit hexadecimal number.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">openssl rand -hex 32</code></pre>
</doc-codeblock></div>
</li>
<li><p>Create a secret with the number generated above.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">apiVersion: v1
kind: Secret
metadata:
  name: datadog
stringData:
  token: &lt;random-hex-32&gt;</code></pre>
</doc-codeblock></div>
</li>
<li><p>Use existing secret in Datadog helm values.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">clusterAgent:
  tokenExistingSecret: datadog</code></pre>
</doc-codeblock></div>
</li>
</ul>
</li>
<li><p>Disable API Instrumentation KPIs by setting the <code translate="no" v-pre>datadog.apm.instrumentation.skipKPITelemetry</code> to <code translate="no" v-pre>false</code> in the datadog helm values.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-yaml"><code v-pre class="language-yaml">datadog:
  apm:
    instrumentation:
      skipKPITelemetry: true</code></pre>
</doc-codeblock></div>
</li>
</ol>
<doc-anchor-target id="eks-addon-update-stucktimeout">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#eks-addon-update-stucktimeout">#</doc-anchor-trigger>
        <span>EKS addon update stuck/timeout</span>
    </h2>
</doc-anchor-target>
<p>Terraform apply can time out updating kube-proxy (or other addons) with errors like:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">Error: waiting for EKS Add-On (cbioportal-prod-a9438edd:kube-proxy) update (...): timeout while waiting for state to become 'Successful' (last state: 'InProgress')</code></pre>
</doc-codeblock></div>
<p>and describing the kube-proxy pod shows:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">FailedScheduling: 0/46 nodes are available: 1 Too many pods, 45 node(s) didn't satisfy plugin(s) [NodeAffinity]</code></pre>
</doc-codeblock></div>
<p>During an addon upgrade each addon pod is pinned to its target node. If that node is at its max pod capacity (e.g., small instance type with max 4 pods), the new pod cannot schedule and the add-on never completes.</p>
<p>Choose an instance type that support at least 10 pods so that addons (aws-node, ebs-csi, efs-csi, eks-identity, kube-proxy, ...) can all run without hitting max pods.</p>
<p>Fix:</p>
<ol>
<li>Identify the blocked node from <code translate="no" v-pre>kubectl -n kube-system describe pod &lt;pod-name&gt;</code>. The pod will also be in pending state.</li>
<li>Check the new node&#x27;s max pod capacity: <code translate="no" v-pre>kubectl get node &lt;node&gt; -o jsonpath='{.status.capacity.pods}'</code>.</li>
<li>Raise the nodegroup instance size in terraform configuration</li>
<li>Rerun <code translate="no" v-pre>terraform apply</code> to let the kube-proxy or other addon finish.</li>
</ol>

                                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer id="retype-content-footer" class="clear-both">
                                <div class="flex flex-wrap items-center justify-between mt-14">
                                    <a id="retype-edit-this-page" class="my-2.5 inline-flex items-center text-sm whitespace-nowrap text-body-link font-body-link hover:text-body-link-hover hover:underline" href="https://github.com/knowledgesystems/knowledgesystems-k8s-deployment/blob/master/docs/troubleshooting.md" target="_blank" rel="noopener">
                                        <svg class="mr-1.5" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M20 12c-.55 0-1 .45-1 1v7c0 .55-.45 1-1 1H4c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h7c.55 0 1-.45 1-1s-.45-1-1-1H4C2.35 3 1 4.35 1 6v14c0 1.65 1.35 3 3 3h14c1.65 0 3-1.35 3-3v-7c0-.55-.45-1-1-1z" /><path d="M22.21 1.79c-1.18-1.18-3.24-1.18-4.41 0l-9.5 9.5c-.13.13-.22.29-.26.46l-1 4c-.08.34.01.7.26.95.18.2.44.3.7.3.08 0 .16-.01.24-.03l4-1c.18-.04.34-.13.46-.26l9.5-9.5c1.22-1.22 1.22-3.2.01-4.42zm-1.42 3l-9.3 9.3-2.11.53.53-2.11 9.3-9.3c.42-.42 1.16-.42 1.59 0 .43.43.43 1.15-.01 1.58z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        <span>Edit on GitHub</span>
                                    </a>
                                </div>
                            
                                <nav id="retype-nextprev" class="print:hidden flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../tutorials/ip-blocking/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-base-text-muted">Previous</span>
                                                <span class="block mt-1">IP Blocking</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../incidents-log/nginx-ingress-timeout-failure/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-base-text-muted">Next</span>
                                                <span class="block mt-1">Nginx-​Ingress Timeout Failure</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div id="retype-page-footer" class="print:border-none border-t border-base-border pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between print:justify-center">
                                <div id="retype-footer-links" class="print:hidden">
                                    <ul class="flex flex-wrap items-center text-sm">
                                    </ul>
                                </div>
                                <div id="retype-copyright" class="print:justify-center py-2 text-footer-text font-footer-link text-sm leading-relaxed"><p>© Copyright 2026. All rights reserved.</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-sidebar-right-bg border-sidebar-right-border lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="retype-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "Troubleshooting", level: 1, icon: "file", hasPrism: true, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
